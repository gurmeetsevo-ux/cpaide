# Secure Document Upload Implementation

## Overview
This document explains the security measures implemented in the document upload functionality for the multi-tenant RAG system.

## Security Architecture

### 1. Tenant Isolation Enforcement
The system implements dual-layer tenant isolation as per the project specifications:
- **IAM Level**: AWS IAM policies restrict S3 access to tenant-specific prefixes
- **Code Level**: Backend validation ensures tenants can only access their own data

### 2. Backend Logic Flow

#### S3 Object Key Generation
```javascript
// The secure object key is generated as:
`tenants/${tenantId}/documents/raw/${documentId}/${uniqueFilename}`
```

**Critical Security Measures:**
1. **Tenant ID Validation**: The `tenantId` comes exclusively from the authenticated JWT token, never from client input
2. **Path Traversal Prevention**: Input validation prevents directory traversal attempts
3. **Unique Filename Generation**: Prevents conflicts and ensures consistent naming
4. **Prefix Enforcement**: The key format is hardcoded to ensure tenant isolation

#### Security Checks in DocumentUploadService

1. **Tenant ID Validation**
   - Validates tenantId format to prevent injection attacks
   - Ensures tenantId contains only safe characters: `/^[a-zA-Z0-9_-]+$/`

2. **Filename Sanitization**
   - Removes path traversal attempts (`../`, `..\\`)
   - Strips null bytes that could be used for exploits
   - Sanitizes special characters in filenames

3. **File Type Validation**
   - Checks MIME type and file extension against allowed types
   - Uses environment configuration for allowed file types
   - Prevents upload of potentially dangerous file types

4. **File Size Validation**
   - Ensures file size is within configured limits
   - Prevents resource exhaustion attacks

5. **Object Key Validation**
   - Verifies that an object key belongs to the correct tenant
   - Provides tenant ID extraction from object keys for validation

## API Endpoints

### POST /api/document-upload/upload-url
**Purpose**: Generate presigned URL for secure file upload
**Authentication**: JWT required
**Security**: Enforces tenant isolation in generated S3 key

**Request Body**:
```json
{
  "fileName": "document.pdf",
  "contentType": "application/pdf",
  "fileSize": 1024000
}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "uploadUrl": "https://s3.amazonaws.com/bucket/...?presigned=true",
    "key": "tenants/tenant_123/documents/raw/temp/filename_unique123.pdf",
    "fileName": "document.pdf"
  },
  "message": "Upload URL generated successfully"
}
```

## Key Security Features

### 1. No Client Control Over S3 Key
- The S3 object key is completely generated by the backend
- Client cannot influence the path or location of the stored file
- Tenant prefix is hardcoded into the key generation logic

### 2. JWT-Based Tenant Context
- Tenant ID is extracted from the authenticated user's JWT token
- Never trusts client-provided tenant context
- Ensures users can only upload to their own tenant space

### 3. Input Validation
- All inputs are validated before processing
- File names are sanitized to prevent path traversal
- MIME types and file sizes are validated

### 4. Temporary vs. Permanent Keys
- Initially generates temporary keys with `temp` document ID
- Can be updated later when actual document ID is available
- Maintains security throughout the process

## Integration with Existing System

The document upload service integrates with:
- Authentication middleware for tenant validation
- Existing document management system
- S3 storage with tenant isolation
- Environment configuration for security parameters

## Defense-in-Depth Approach

This implementation follows the "Dual-Layer Tenant Isolation Enforcement" pattern:
1. **Application Layer**: Validates tenant context from JWT and enforces business logic
2. **Infrastructure Layer**: AWS IAM policies provide additional access control

This ensures that even if one layer is compromised, the other provides protection.